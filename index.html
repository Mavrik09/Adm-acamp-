<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Painel Administrativo ‚Äî Inscri√ß√µes</title>

<!-- Firebase libs (v8 compat√≠vel) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --accent:#0b5fff; --danger:#dc2626; --radius:12px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#f8fbff,#f5f7fb);margin:0;color:#0f172a;-webkit-font-smoothing:antialiased}
  .wrap{max-width:1200px;margin:20px auto;padding:16px}
  .card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.06);margin-bottom:16px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px;flex-wrap:wrap}
  .brand h1{color:var(--accent);font-size:20px;margin:0}
  .logout-btn{background:#ef4444;color:#fff;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .tablink{padding:10px 14px;border-radius:10px;border:0;background:transparent;color:var(--muted);cursor:pointer}
  .tablink.active{background:var(--card);color:var(--accent);font-weight:700;box-shadow:0 6px 18px rgba(11,95,255,0.06)}
  .filters-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media(max-width:920px){.filters-grid{grid-template-columns:1fr}}
  .filters-grid label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ee;background:#fbfdff}
  .actions-row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--accent);color:#fff}
  .btn-ghost{background:transparent;border:1px solid #e6e9ee;color:var(--muted)}
  table{width:100%;border-collapse:collapse;min-width:700px}
  th{padding:12px 16px;background:#fbfdff;color:var(--accent);text-align:left}
  td{padding:12px 16px;border-bottom:1px solid #f3f6fb;vertical-align:top}
  tr:hover td{background:#fbfdff}
  .status-pill{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .table-container{overflow:auto;border-radius:12px}
  /* Modal organised */
  /* --- MODAL RESPONSIVO E SCROLL√ÅVEL --- */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(3, 7, 18, 0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 10px;
}

.modal-card {
  display: flex;
  flex-direction: column;
  width: min(980px, 96%);
  max-height: 95vh;
  background: var(--card);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 18px 60px rgba(2,6,23,0.35);
}

/* Cabe√ßalho fixo */
.modal-header {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  border-bottom: 1px solid #f2f6fb;
  background: #fff;
  position: sticky;
  top: 0;
  z-index: 10;
}

/* Corpo rolagem pr√≥pria */
.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 18px;
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 16px;
}

.modal-body::-webkit-scrollbar {
  width: 6px;
}
.modal-body::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 4px;
}

/* Rodap√© fixo */
.modal-card > div:last-child {
  flex-shrink: 0;
  padding: 12px 18px;
  border-top: 1px solid #f2f6fb;
  background: #fff;
  position: sticky;
  bottom: 0;
}

/* Mobile: empilha colunas e ocupa quase 100% */
@media (max-width: 820px) {
  .modal-body {
    grid-template-columns: 1fr;
    padding: 14px;
    gap: 10px;
  }
  .modal-card {
    width: 100%;
    height: 100%;
    max-height: none;
    border-radius: 0;
  }
}

  @media(max-width:980px){ .modal-card{width:96%} }
  @media(max-width:820px){ .modal-body{grid-template-columns:1fr;padding:14px;gap:12px} }
  .side-card{background:#fff;padding:12px;border-radius:10px;border:1px solid #f3f6fb}
  /* suggestions */
  #masterSearchSuggestions{margin-top:6px;border-radius:10px;max-height:220px;overflow:auto;background:#fff;border:1px solid #f0f4ff}
  .sugg-item{padding:10px 12px;border-bottom:1px solid #f5f7fb;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .sugg-item:hover{background:#fbfdff}
  .helper{font-size:13px;color:var(--muted);margin-top:8px}
  /* Mobile-friendly inputs/groups */
  .payment-row{display:flex;gap:10px;flex-wrap:wrap}
  .payment-row > *{flex:1;min-width:140px}
  @media(max-width:560px){
    .payment-row{flex-direction:column}
    .actions-row{flex-direction:column}
    .actions-row .btn{width:100%}
    .sugg-item{padding:12px}
  }
  /* responsive table -> card style for small screens using data-label */
  @media(max-width:760px){
    table, thead, tbody, th, td, tr { display:block; }
    thead { display:none; }
    tr { margin-bottom:12px; border-radius:10px; background:#fff; box-shadow:0 6px 18px rgba(2,6,23,0.04); padding:10px; }
    td { border:0; padding:8px 10px; position:relative; }
    td::before { content: attr(data-label); font-weight:700; display:block; color:var(--muted); margin-bottom:6px; }
    /* action button full width */
    .action-btn { display:block; width:100%; box-sizing:border-box; margin-top:8px; }
  }

  /* small tweaks */
  .muted{color:var(--muted);}
  .mini{font-size:13px}
</style>
</head>
<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="login-screen" class="card" style="display:block">
    <h2 style="color:var(--accent);text-align:center;margin-bottom:12px">√Årea Administrativa</h2>
    <form id="loginForm" style="max-width:420px;margin:0 auto">
      <input id="adminEmail" type="email" placeholder="E-mail ADM" required style="margin-bottom:8px"/>
      <input id="adminPassword" type="password" placeholder="Senha" required style="margin-bottom:8px"/>
      <button type="submit" class="btn btn-primary" style="width:100%">Entrar</button>
      <p id="loginMessage" class="helper" style="text-align:center;margin-top:10px"></p>
    </form>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard-screen" style="display:none">
    <div class="header card header">
      <div class="brand"><h1>Painel Administrativo ‚Äî Inscri√ß√µes</h1></div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <button id="exportCsvButton" class="btn" style="background:#16a34a;color:#fff">Exportar CSV</button>
        <button id="logoutButton" class="logout-btn">Sair</button>
      </div>
    </div>

    <div class="tabs">
      <button id="tabMain" class="tablink active" onclick="showMainDashboard()">üìã Inscri√ß√µes</button>
      <button id="tabHealth" class="tablink" onclick="showHealthDashboard()">üè• Sa√∫de</button>
    </div>

    <!-- MAIN -->
    <div id="dashboardMain" class="card" style="display:block">
      <h3>Lista de Inscri√ß√µes</h3>

      <div class="card" style="margin-top:12px">
        <h4>Filtros e Busca</h4>
        <div class="filters-grid">
          <div>
            <label>Status de Pagamento</label>
            <select id="statusFilter"><option>Todos</option><option>PENDENTE</option><option>PAGO PARCIAL</option><option>PAGO TOTAL</option></select>
          </div>
          <div>
            <label>Fam√≠lia ABBApai</label>
            <select id="abbaFilter"><option>Todos</option><option>Sim</option><option>Nao</option></select>
          </div>
          <div>
            <label>Buscar por Nome / Email</label>
            <input id="searchName" type="text" placeholder="Nome ou e-mail"/>
          </div>
        </div>

        <div class="actions-row" style="margin-top:12px">
          <button id="btnApplyFilters" class="btn btn-primary" onclick="loadInscricoes()">Aplicar</button>
          <button id="btnClearFilters" class="btn btn-ghost" onclick="clearFilters()">Limpar</button>
          <div style="flex:1"></div>
          <p id="exportMessage" class="helper"></p>
        </div>
      </div>

      <div class="table-container card">
        <table>
          <thead><tr><th>Nome</th><th>E-mail</th><th>Status</th><th>A√ß√µes</th></tr></thead>
          <tbody id="inscricoesBody"></tbody>
        </table>
      </div>
    </div>

    <!-- HEALTH -->
    <div id="dashboardHealth" class="card" style="display:none">
      <h3>Participantes com Restri√ß√µes/Alergias</h3>
      <div style="margin-top:12px">
        <label>Buscar por Nome/Email</label>
        <input id="searchNameHealth" type="text" placeholder="Digite para filtrar (busca autom√°tica)"/>
      </div>
      <div class="table-container card" style="margin-top:12px">
        <table>
          <thead><tr><th>Nome / Tel</th><th>Restri√ß√£o</th><th>Condi√ß√£o</th><th>Menor</th><th>Notas ADM</th></tr></thead>
          <tbody id="inscricoesBodySaude"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- REORGANIZED MODAL -->
<div id="modalAdmin" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalAdminTitle">
  <div class="modal-card" role="document">
    <div class="modal-header">
      <div class="modal-title" id="modalAdminTitle">Editar Inscri√ß√£o ‚Äî Detalhes e Pagamento</div>
      <div>
        <button id="btnCloseModalAdmin" class="btn btn-ghost">Fechar</button>
      </div>
    </div>

    <div class="modal-body">
      <!-- LEFT -->
      <div>
        <div style="margin-bottom:12px">
          <label>ID do Documento: <span id="inscricaoDocId">‚Äî</span></label>
        </div>

        <div style="margin-bottom:12px">
          <label for="modalValorDevido">Valor Total Devido (R$)</label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="modalValorDevido" type="number" step="0.01" />
            <button class="btn btn-primary" onclick="updateValorDevido()">Salvar Valor</button>
          </div>
          <p id="devidoMessage" class="helper"></p>
        </div>

        <div class="card" style="margin-bottom:12px">
          <h4>Resumo Financeiro</h4>
          <p>Valor Total Devido: <strong id="valorDevidoDisplay">R$ 0,00</strong></p>
          <p>Total Pago: <strong id="totalPagoDisplay">R$ 0,00</strong></p>
          <p>Saldo Restante: <strong id="saldoRestanteDisplay">R$ 0,00</strong></p>
          <p>Status: <strong id="statusPagamentoDisplay">PENDENTE</strong></p>
        </div>

        <form id="paymentForm" class="card">
          <h4>Lan√ßar Pagamento / Estorno</h4>
          <div class="payment-row">
            <div>
              <label for="paymentMethod">Meio</label>
              <select id="paymentMethod" required>
                <option value="PIX">PIX</option>
                <option value="TED">TED/Transfer√™ncia</option>
                <option value="CARTAO">Cart√£o</option>
                <option value="DINHEIRO">Dinheiro</option>
                <option value="OUTRO">Outro</option>
              </select>
            </div>
            <div>
              <label for="paymentValue">Valor (R$)</label>
              <input id="paymentValue" type="number" step="0.01" placeholder="Ex: 50.00"/>
            </div>
            <div>
              <label for="paymentDate">Data</label>
              <input id="paymentDate" type="date"/>
            </div>
          </div>

          <div style="margin-top:10px">
            <button type="submit" class="btn btn-primary">Lan√ßar Pagamento</button>
            <p id="paymentMessage" class="helper" style="margin-top:8px"></p>
          </div>

          <div id="paymentHistory" style="margin-top:12px">
            <h5>Hist√≥rico de Pagamentos</h5>
            <ul id="historyList" style="max-height:220px;overflow:auto;padding-left:18px"></ul>
          </div>
        </form>

        <div class="card" style="margin-top:12px">
          <h4>V√≠nculo de Grupo / Fam√≠lia (Pagamento √önico)</h4>
          <p class="helper">Digite o nome do titular (m√≠n. 3 letras) para buscar, ou cole o ID</p>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="masterIdInput" type="text" placeholder="Nome do Titular ou ID" />
            <div style="display:flex;gap:8px">
              <button class="btn btn-primary" onclick="updateGroupLink()">Vincular</button>
              <button class="btn btn-ghost" onclick="removeGroupLink()">Remover</button>
            </div>
          </div>
          <div id="masterSearchSuggestions" aria-live="polite"></div>
          <p id="groupLinkMessage" class="helper" style="margin-top:6px"></p>
          <p style="margin-top:8px;">V√≠nculo Atual: <strong id="masterIdDisplay">Nenhum</strong></p>
          <div id="dependentesContainer" style="margin-top:10px" class="helper"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <aside class="side-card">
        <div style="margin-bottom:10px">
          <strong>Resumo</strong>
          <p id="selectedMasterPreview" class="helper">Nenhum titular selecionado.</p>
        </div>

        <div style="margin-top:8px">
          <strong>Detalhes da Inscri√ß√£o</strong>
          <div style="margin-top:8px">
            <label>Nome</label><input id="modalNomeCompleto" type="text"/>
            <label style="margin-top:8px">E-mail</label><input id="modalEmail" type="email"/>
            <label style="margin-top:8px">Telefone</label><input id="modalTelefone" type="text"/>
            <label style="margin-top:8px">Pertence ABBApai</label>
            <select id="modalABBApai"><option value="true">Sim</option><option value="false">N√£o</option></select>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
              <button id="saveDetailsButton" class="btn btn-primary">Salvar Altera√ß√µes</button>
              <button id="btnRemoveLink" class="btn btn-ghost" onclick="removeGroupLink()">Remover V√≠nculo</button>
            </div>
            <p id="saveDetailsMessage" class="helper" style="margin-top:8px"></p>
          </div>
        </div>
      </aside>
    </div>

    <div style="padding:12px 18px;border-top:1px solid #f2f6fb;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <div class="helper">√öltima a√ß√£o: <span id="lastAction">‚Äî</span></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnExport" class="btn btn-ghost">Exportar</button>
        <button id="btnCloseModalFooter" class="btn btn-ghost">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script src="admin.js"></script>
</body>
</html>
